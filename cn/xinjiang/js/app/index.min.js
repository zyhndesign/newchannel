var ZY=ZY||{};ZY.Config=function(){return{ajaxurl:"http://www.comdesignlab.com/travel/wp-admin/admin-ajax.php",siteurl:"http://www.comdesignlab.com/travel",errorCode:{connectionError:"无法连接到服务器。",musicError:"无法从服务器获取音乐。",hasNoMusic:"没有上传音乐",postsError:"无法从服务器获取文章摘要。",articleError:"无法从服务器获取文章详情。"},deviceCode:{iOS:navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?true:false}}}();var ZY=ZY||{};ZY.UIManager=function(){var lastBlackoutZ=0;var musicPlaying=false;var rect="";var navH=$("#zy_nav").height();var landScapeBG=$("#zy_landscape_theme .zy_theme_bg_content");var peopleBG=$("#zy_people_theme .zy_theme_bg_content");var artifactBG=$("#zy_artifact_theme .zy_theme_bg_content");var communityBG=$("#zy_community_theme .zy_theme_bg_content");var ftY=$(".zy_featured").offset().top;var landScapeY=$("#zy_landscape").offset().top;var peopleY=$("#zy_people").offset().top;var artifactY=$("#zy_artifact").offset().top;var communityY=$("#zy_community").offset().top;var footerY=$(".zy_footer").offset().top;var showBlackout=function(zindex){lastBlackoutZ=$("#zy_wrap").css("z-index");$("#zy_wrap").css("z-index",zindex);if($("#zy_wrap").hasClass("zy_hidden")){$("#zy_wrap").removeClass("zy_hidden")}};var hideBlackout=function(){if(!$("#zy_wrap").hasClass("zy_hidden")){$("#zy_wrap").addClass("zy_hidden");$("#zy_wrap").css("z-index",lastBlackoutZ)}};return{musicLiLength:0,scrollToTarget:function(target){var top=$(target).offset().top;if(top!=undefined){TweenLite.killTweensOf(window);TweenLite.to(window,1,{scrollTo:{y:top+10,x:0}})}},showArticle:function(post_id,post_type){var _self=this;$("#zy_article_content").find("article").remove();showBlackout(9996);$("#zy_article_container").animate({left:"0%"},300,function(){_self.callLoadingSpinner($("#zy_article_content"));ZY.DataManager.get_posts_detail(post_id,post_type)})},hideArticle:function(){$("#zy_article_container").animate({left:"100%"},300);hideBlackout();this.hideLoadingSpinner($("#zy_article_content"))},showVideoDetail:function(url){var _self=this;$("#zy_show_load_container").html("");showBlackout(9998);$("#zy_show_section").removeClass("zy_hidden");$("#zy_show_load_container").load(url,function(response,status,xhr){_self.hideLoadingSpinner($("#zy_article_content"));if(status=="error"){_self.popOutMsg(ZY.Config.errorCode.connectionError+xhr.status+" "+xhr.statusText)}});$("#zy_music_audio")[0].pause()},showImageDetail:function(url){showBlackout(9998);$("#zy_show_section").removeClass("zy_hidden");$("#zy_show_load_container").html("<img src='"+url+"'>")},hideDetail:function(){var audio=$("#zy_music_audio")[0];$("#zy_wrap").css("z-index",lastBlackoutZ);$("#zy_show_section").addClass("zy_hidden");$("#zy_show_load_container").html("");if(musicPlaying){audio.play()}},initMusicPlayer:function(){var _self=this;var audio=$("#zy_music_audio");$("#zy_music_control").click(function(){_self.toggleMusicPlayPause()});$("#zy_music_next").click(function(){_self.nextMusic()});audio[0].addEventListener("timeupdate",function(){var audio=$(this)[0];var totalTime=audio.duration;var currentTime=audio.currentTime;$("#zy_music_process_value").css("width",currentTime/totalTime*100+"%")});audio[0].addEventListener("ended",function(){_self.nextMusic()})},toggleMusicPlayPause:function(){if(this.musicLiLength!=0){if($("#zy_music_control").hasClass("zy_music_play")){this.playMusic()}else if($("#zy_music_control").hasClass("zy_music_pause")){this.pauseMusic()}}},pauseMusic:function(){var audio=$("#zy_music_audio");audio[0].pause();musicPlaying=false;audio.attr("autoplay",false);$("#zy_music_control").removeClass("zy_music_pause").addClass("zy_music_play")},playMusic:function(){var audio=$("#zy_music_audio");audio[0].play();musicPlaying=true;audio.attr("autoplay","autoplay");$("#zy_music_control").addClass("zy_music_pause").removeClass("zy_music_play")},nextMusic:function(){if(this.musicLiLength!=0){$("#zy_music_process_value").stop().width("0%");var target=$(".active_music").next().length!=0?$(".active_music").next():$("#zy_music_list li:eq(0)");$(".active_music").removeClass("active_music");$("#zy_music_audio").attr("src",target.html());$("#zy_music_author").html("Directed by "+target.data("music-author"));$("#zy_music_title").html(target.data("music-title"));target.addClass("active_music")}},popOutInit:function(){var _self=this;$("#zy_popout_win>.zy_popout_btn").on("click",function(){_self.popOutHide()});if(!$("#zy_popout_win").hasClass("zy_hidden")){$("#zy_popout_win").addClass("zy_hidden")}},popOutMsg:function(msg,showblackout){if($("#zy_popout_win").hasClass("zy_hidden")){$("#zy_popout_win").removeClass("zy_hidden").find(".zy_popout_title").html(msg)}if(showblackout){showBlackout(9999)}},popOutHide:function(){$("#zy_popout_win").addClass("zy_hidden").find(".zy_popout_title").html("")},callLoadingSpinner:function(target){var spinnerDOM="<div class='zy_loading_spinner'>"+"<div class='zy_loading_spinner_layer1'></div>"+"<div class='zy_loading_spinner_layer2'></div></div>";var spinner=$(spinnerDOM);if($(target).find(".zy_loading_spinner").length<=0){$(target).append(spinner)}},hideLoadingSpinner:function(target){$(target).find(".zy_loading_spinner").detach()},updateSectionBG:function(data,target){if(data["background"]){if(data["background"]["type"]!="mp4"){$(target).append($("<img class='zy_theme_bg_content' src='"+data["background"]["filepath"]+"' onload='ZY.UIManager.fadingIn(this)' />"))}else if(!ZY.Config.deviceCode.iOS){$(target).append($("<video class='zy_theme_bg_content' autoplay loop muted oncanplay='ZY.UIManager.fadingIn(this)'><source src='"+data["background"]["filepath"]+"' type='video/mp4' /></video>"))}landScapeBG=$("#zy_landscape_theme .zy_theme_bg_content");peopleBG=$("#zy_people_theme .zy_theme_bg_content");artifactBG=$("#zy_artifact_theme .zy_theme_bg_content");communityBG=$("#zy_community_theme .zy_theme_bg_content")}},bindHScrollOnWheel:function(target){var mousewheelEvt=document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";var mousewheelHandler=function(evt){var left=0;evt=window.event||evt;if(evt.wheelDelta<0||evt.detail>0){left=target.scrollLeft+500}else{left=target.scrollLeft-500}TweenLite.to(target,.5,{scrollTo:{x:left}});if(evt.preventDefault){evt.preventDefault()}else{evt.returnValue=false}};target.addEventListener(mousewheelEvt,mousewheelHandler)},setWheelScrollSpeed:function(){var mousewheelEvt=document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll";var mousewheelHandler=function(evt){var top=$(window).scrollTop();evt=window.event||evt;if(evt.wheelDelta<0||evt.detail>0){$(window).scrollTop(top+100)}else{$(window).scrollTop(top-100)}if(evt.preventDefault){evt.preventDefault()}else{evt.returnValue=false}};window.addEventListener(mousewheelEvt,mousewheelHandler)},fadingIn:function(target){$(target).css("opacity",1)},scrollingHandler:function(){var sy=window.pageYOffset;var winH=$(window).height();var winW=$(window).width();if(sy<=ftY){$("#zy_nav").css("top",100+(landScapeY-navH-200)/ftY*sy)}$(".zy_top_nav ul li a").removeClass("active");if(sy<=landScapeY){}else if(sy<=peopleY){$(".zy_top_nav ul li:nth-child(1) a").addClass("active")}else if(sy<=artifactY){$(".zy_top_nav ul li:nth-child(2) a").addClass("active")}else if(sy<=communityY){$(".zy_top_nav ul li:nth-child(3) a").addClass("active")}else if(sy<=footerY){$(".zy_top_nav ul li:nth-child(4) a").addClass("active")}if(sy>landScapeY-winH&&sy<=landScapeY+720){if(!ZY.Config.deviceCode.iOS){landScapeBG.addClass("zy_bg_fixed");rect="rect(0px "+winW+"px "+(720-(sy-landScapeY)+100)+"px 0px)";landScapeBG.css("clip",rect)}if(!ZY.DataManager.landscapeLoaded){ZY.DataManager.zy_get_posts($("#zy_landscape_contain"),240,3,ZY.DataManager.lastLandscapeDate,true);ZY.DataManager.landscapeLoaded=true}}else{if(!ZY.Config.deviceCode.iOS){landScapeBG.removeClass("zy_bg_fixed");landScapeBG.css("clip","")}}if(sy>peopleY-winH&&sy<=peopleY+720){if(!ZY.Config.deviceCode.iOS){peopleBG.addClass("zy_bg_fixed");rect="rect(0px "+winW+"px "+(720-(sy-peopleY)+100)+"px 0px)";peopleBG.css("clip",rect)}if(!ZY.DataManager.peopleLoaded){ZY.DataManager.zy_get_posts($("#zy_people_contain"),340,2,ZY.DataManager.lastPeopleDate,true);ZY.DataManager.peopleLoaded=true}}else{if(!ZY.Config.deviceCode.iOS){peopleBG.removeClass("zy_bg_fixed");peopleBG.css("clip","")}}if(sy>artifactY-winH&&sy<=artifactY+720){if(!ZY.Config.deviceCode.iOS){artifactBG.addClass("zy_bg_fixed");rect="rect(0px "+winW+"px "+(720-(sy-artifactY)+100)+"px 0px)";artifactBG.css("clip",rect)}if(!ZY.DataManager.artifactLoaded){ZY.DataManager.zy_get_posts($("#zy_artifact_contain"),400,5,ZY.DataManager.lastArtifactDate,true);ZY.DataManager.artifactLoaded=true}}else{if(!ZY.Config.deviceCode.iOS){artifactBG.removeClass("zy_bg_fixed");artifactBG.css("clip","")}}if(sy>communityY-winH&&sy<=communityY+720){if(!ZY.Config.deviceCode.iOS){communityBG.addClass("zy_bg_fixed");rect="rect(0px "+winW+"px "+(720-(sy-communityY)+100)+"px 0px)";communityBG.css("clip",rect)}if(!ZY.DataManager.communityLoaded){ZY.DataManager.zy_get_posts($("#zy_community_contain"),340,4,ZY.DataManager.lastCommunityDate,true);ZY.DataManager.communityLoaded=true}}else{if(!ZY.Config.deviceCode.iOS){communityBG.removeClass("zy_bg_fixed");communityBG.css("clip","")}}},doResizeOfCategory:function(targetContain,width,loaded){var limit=parseInt($("body").width()/width);var nextBtn=targetContain.find("a.zy_contain_next");var list=targetContain.find("ul");var targetContainer=targetContain.find(".zy_list_container");targetContainer.width(limit*width);if(parseInt(list.css("left"))>-(list.find("li").length-limit)*width&&loaded){nextBtn.removeClass("zy_disable")}else{if(loaded){nextBtn.addClass("zy_disable")}}}}}();var ZY=ZY||{};ZY.DataManager={top_post_id:0,landscapeLoaded:false,peopleLoaded:false,artifactLoaded:false,communityLoaded:false,lastPeopleDate:"",lastLandscapeDate:"",lastCommunityDate:"",lastArtifactDate:"",zy_insert_people:function(data){var tpl=$("#zy_people_articles_tpl").html();var html=juicer(tpl,{posts:data});$("#zy_people_list").append($(html))},zy_insert_landscape:function(data){var tpl=$("#zy_landscape_articles_tpl").html();var html=juicer(tpl,{posts:data});$("#zy_landscape_list").append($(html))},zy_insert_community:function(data){var tpl=$("#zy_community_articles_tpl").html();var html=juicer(tpl,{posts:data});$("#zy_community_list").append($(html))},zy_insert_artifact:function(data){var tpl=$("#zy_artifact_articles_tpl").html();var html=juicer(tpl,{posts:data});$("#zy_artifact_list").append($(html))},zy_set_limit:function(targetContain,width,categoryId,isFirst){var limit=parseInt($("body").width()/width);targetContain.find(".zy_list_container").width(limit*width);ZY.UIManager.callLoadingSpinner($(targetContain));if(isFirst){if(categoryId==3){if($("body").width()>=720){limit=parseInt(($("body").width()-720)/width)+limit*2+1}}else{limit=limit*3}}else{limit=limit*2}return limit},zy_do_response:function(targetContain,data,isFirst,categoryId,limit){var length=data.length;var nextBtn=targetContain.find(".zy_contain_next");if(isFirst&&length!=0&&data[0]["post_id"]!=this.top_post_id){if(categoryId==2){ZY.UIManager.updateSectionBG(data[0],$("#zy_people_theme"))}else if(categoryId==3){ZY.UIManager.updateSectionBG(data[0],$("#zy_landscape_theme"))}else if(categoryId==4){ZY.UIManager.updateSectionBG(data[0],$("#zy_comunity_theme"))}else if(categoryId==5){ZY.UIManager.updateSectionBG(data[0],$("#zy_artifact_theme"))}}if(length<=limit){if(length!=0){if(categoryId==2){this.lastPeopleDate=data[length-1]["post_full_date"];this.zy_insert_people(data)}else if(categoryId==3){this.lastLandscapeDate=data[length-1]["post_full_date"];this.zy_insert_landscape(data)}else if(categoryId==4){this.lastCommunityDate=data[length-1]["post_full_date"];this.zy_insert_community(data)}else{this.lastArtifactDate=data[length-1]["post_full_date"];this.zy_insert_artifact(data)}}nextBtn.removeClass("zy_disable");if(categoryId==3){if(!(isFirst&&length<=(limit+2)/3-2)){nextBtn.removeClass("zy_disable")}}else{if(!(isFirst&&length<=limit/3)){nextBtn.removeClass("zy_disable")}}if(length<limit){nextBtn.addClass("zy_no_more")}}},zy_get_posts:function(targetContain,width,categoryId,lastDate,isFirst){var limit=this.zy_set_limit(targetContain,width,categoryId,isFirst);$(targetContain).find(".zy_contain_next").addClass("zy_disable");$.ajax({url:ZY.Config.ajaxurl,type:"post",data:{limit:limit,lastDate:lastDate,categoryId:categoryId,action:"zy_get_posts"},success:function(response){if(response.success){var data=response.data;ZY.DataManager.zy_do_response(targetContain,data,isFirst,categoryId,limit)}else{ZY.UIManager.popOutMsg(ZY.Config.errorCode.postsError)}ZY.UIManager.hideLoadingSpinner($(targetContain))},error:function(){ZY.UIManager.hideLoadingSpinner($(targetContain));ZY.UIManager.popOutMsg(ZY.Config.errorCode.connectionError)}})},get_posts_detail:function(post_id,post_type){$.ajax({url:ZY.Config.ajaxurl,type:"post",data:{post_id:post_id,action:"zy_get_post_detail"},success:function(response){if(response.success){var tpl=$("#zy_show_detail_tpl").html();var data=response.data;var html=juicer(tpl,data);$("#zy_article_content").append(html);ZY.UIManager.hideLoadingSpinner($("#zy_article_content"))}else{ZY.UIManager.popOutMsg(ZY.Config.errorCode.articleError)}},error:function(){ZY.UIManager.popOutMsg(ZY.Config.errorCode.connectionError)}})},add_hover_event:function(targetContain,targetList,targetPrev,targetNext){var container=$(targetContain).find(".zy_list_container");var list=$(targetContain).find(".zy_list_container>ul");var nextBtn=$(targetContain).find(".zy_contain_next");var prevBtn=$(targetContain).find(".zy_contain_prev");targetContain.hover(function(){prevBtn.css("opacity",1);nextBtn.css("opacity",1);if(parseInt(targetList.css("left"))>=0){prevBtn.addClass("zy_disable")}},function(){prevBtn.css("opacity",0);nextBtn.css("opacity",0)})},show_next_animate:function(targetContain,width,categoryId,lastDate){var limit=parseInt($("body").width()/width);var nextBtn=$(targetContain).find("a.zy_contain_next");var prevBtn=$(targetContain).find("a.zy_contain_prev");var container=$(targetContain).find(".zy_list_container");var list=$(targetContain).find(".zy_list_container ul");container.width(limit*width);if(nextBtn.hasClass("zy_no_more")){list.animate({left:parseInt(list.css("left"))-limit*width},500,function(){prevBtn.removeClass("zy_disable");if(categoryId==3){if(parseInt(list.css("left"))<=-(list.find("li").length-limit+2)*width){nextBtn.addClass("zy_disable")}}else{if(parseInt(list.css("left"))<=-(list.find("li").length-limit)*width){nextBtn.addClass("zy_disable")}}})}else{this.zy_get_posts(targetContain,width,categoryId,lastDate,false);list.animate({left:parseInt(list.css("left"))-limit*width},500,function(){prevBtn.removeClass("zy_disable")})}},show_prev_animate:function(targetContain,width,categoryId){var limit=parseInt($("body").width()/width);var nextBtn=$(targetContain).find("a.zy_contain_next");var prevBtn=$(targetContain).find("a.zy_contain_prev");var container=$(targetContain).find(".zy_list_container");var list=$(targetContain).find(".zy_list_container ul");container.width(limit*width);if(parseInt(list.css("left"))+limit*width>0){list.animate({left:0},500,function(){if(parseInt(list.css("left"))>-(list.find("li").length-limit)*width){nextBtn.removeClass("zy_disable")}prevBtn.addClass("zy_disable")})}else{if(categoryId==3){if(parseInt(list.css("left"))+limit*width>-720&&parseInt(list.css("left"))+limit*width<0&&$("body").width()>720){list.animate({left:-720},500,function(){nextBtn.removeClass("zy_disable")});return}}list.animate({left:parseInt(list.css("left"))+limit*width},500,function(){nextBtn.removeClass("zy_disable");if(parseInt(list.css("left"))==0){prevBtn.addClass("zy_disable")}})}}};$(document).ready(function(){var post_id=0;(function(){$.ajax({url:ZY.Config.ajaxurl,type:"post",data:{action:"zy_get_top_posts",programId:1},success:function(response){if(response.success){if(response.data.length!=0){var posts=response.data;ZY.DataManager.top_post_id=posts[0]["post_id"];var tpl_top=$("#zy_top_post_tpl").html();var html_top=juicer(tpl_top,{top_posts:posts});$("#zy_top_post_heading").html(html_top);ZY.UIManager.updateSectionBG(posts[0],$("#zy_top_post_poster"));var tpl_featured=$("#zy_featured_articles_tpl").html();var html_featured=juicer(tpl_featured,{top_posts:posts});$("#zy_featured_articles").html(html_featured)}}else{ZY.UIManager.popOutMsg(ZY.Config.errorCode.postsError)}},error:function(){ZY.UIManager.popOutMsg(ZY.Config.errorCode.connectionError)}})})();(function(){$.ajax({url:ZY.Config.ajaxurl,type:"post",data:{action:"zy_get_music",programId:1},success:function(response){if(response.success){if(response.data.length!=0){var musics=response.data;var tpl=$("#zy_music_tpl").html();var html=juicer(tpl,{musics:musics});$("#zy_music_list").html(html);$("#zy_music_audio").attr("src",musics[0].music_path);$("#zy_music_author").html("Directed by "+musics[0].music_author);$("#zy_music_title").html(musics[0].music_title);ZY.UIManager.musicLiLength=musics.length}else{$("#zy_music_title").text(ZY.Config.errorCode.hasNoMusic)}}else{ZY.UIManager.popOutMsg(ZY.Config.errorCode.musicError)}},error:function(){ZY.UIManager.popOutMsg(ZY.Config.errorCode.connectionError)}})})();$("#zy_top_nav a,#zy_nav a").click(function(){var target=$(this).attr("href");ZY.UIManager.scrollToTarget(target);return false});$("#zy_logo a").click(function(){ZY.UIManager.scrollToTarget("#zy_top_post");return false});ZY.UIManager.bindHScrollOnWheel($("#zy_article_content")[0]);if(ZY.Config.deviceCode.iOS){$(".zy_article_content").addClass("zy_touch_hscroll");$("#zy_landscape_list_container").addClass("zy_touch_hscroll");$("#zy_people_list_container").addClass("zy_touch_hscroll");$("#zy_artifact_list_container").addClass("zy_touch_hscroll");$("#zy_community_list_container").addClass("zy_touch_hscroll")}$(document).on("click","#zy_top_post_title",function(){var url="";post_id=$(this).data("zy-post-id");var post_type=$(this).data("zy-post-type");ZY.UIManager.showArticle(post_id,post_type)});ZY.UIManager.initMusicPlayer();ZY.DataManager.add_hover_event($("#zy_landscape_contain"),$("#zy_landscape_list"),$("#zy_landscape_prev"),$("#zy_landscape_next"));ZY.DataManager.add_hover_event($("#zy_people_contain"),$("#zy_people_list"),$("#zy_people_prev"),$("#zy_people_next"));ZY.DataManager.add_hover_event($("#zy_artifact_contain"),$("#zy_artifact_list"),$("#zy_artifact_prev"),$("#zy_artifact_next"));ZY.DataManager.add_hover_event($("#zy_community_contain"),$("#zy_community_list"),$("#zy_community_prev"),$("#zy_community_next"));$("#zy_landscape_next").click(function(){ZY.DataManager.show_next_animate($("#zy_landscape_contain"),240,3,ZY.DataManager.lastLandscapeDate)});$("#zy_landscape_prev").click(function(){ZY.DataManager.show_prev_animate($("#zy_landscape_contain"),240,3)});$("#zy_people_next").click(function(){ZY.DataManager.show_next_animate($("#zy_people_contain"),340,2,ZY.DataManager.lastPeopleDate)});$("#zy_people_prev").click(function(){ZY.DataManager.show_prev_animate($("#zy_people_contain"),340,2)});$("#zy_artifact_next").click(function(){ZY.DataManager.show_next_animate($("#zy_artifact_contain"),400,5,ZY.DataManager.lastArtifactDate)});$("#zy_artifact_prev").click(function(){ZY.DataManager.show_prev_animate($("#zy_artifact_contain"),400,5)});$("#zy_community_next").click(function(){ZY.DataManager.show_next_animate($("#zy_community_contain"),340,4,ZY.DataManager.lastCommunityDate)});$("#zy_community_prev").click(function(){ZY.DataManager.show_prev_animate($("#zy_community_contain"),340,4)});$("#zy_show_close").click(function(){ZY.UIManager.hideDetail()});ZY.UIManager.popOutInit();$(document).on("click","li[data-zy-post-type^=zy]",function(){post_id=$(this).data("zy-post-id");var post_type=$(this).data("zy-post-type");ZY.UIManager.showArticle(post_id,post_type)});$("#zy_article_content_close").click(function(){ZY.UIManager.hideArticle()});$(document).on("click","#zy_article_content a",function(){var url;var elementA=$(this);if(elementA.hasClass("videoslide")){url=ZY.Config.siteurl+"/show_media/"+post_id+"/"+elementA.find("img").data("zy-media-id");ZY.UIManager.showVideoDetail(url);return false}else if(elementA.find("img")){url=elementA.attr("href");ZY.UIManager.showImageDetail(url);return false}else{window.open(elementA.attr("href"))}});$(window).on("scroll",function(evt){ZY.UIManager.scrollingHandler()});$(window).trigger("scroll");var resizeTimer=null;$(window).resize(function(){if(resizeTimer){clearTimeout(resizeTimer)}resizeTimer=setTimeout(function(){ZY.UIManager.doResizeOfCategory($("#zy_people_contain"),340,ZY.DataManager.peopleLoaded);ZY.UIManager.doResizeOfCategory($("#zy_landscape_contain"),240,ZY.DataManager.landscapeLoaded);ZY.UIManager.doResizeOfCategory($("#zy_community_contain"),340,ZY.DataManager.communityLoaded);ZY.UIManager.doResizeOfCategory($("#zy_artifact_contain"),400,ZY.DataManager.artifactLoaded)},200)})});